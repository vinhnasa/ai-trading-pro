import streamlit as st
import yfinance as yf
import pandas_ta as ta
import google.generativeai as genai
import streamlit.components.v1 as components
import requests
from streamlit_searchbox import st_searchbox 
import warnings

# --- 1. C·∫§U H√åNH H·ªÜ TH·ªêNG ---
st.set_page_config(
    page_title="AI Trading Pro", 
    layout="wide", 
    page_icon="ü¶Å",
    initial_sidebar_state="expanded"
)
warnings.filterwarnings("ignore")

# ==========================================
# üîë KHU V·ª∞C NH·∫¨P API KEY C·ª¶A B·∫†N
# ==========================================
MY_API_KEY = "AIzaSyCtnQ98VfegW3tbswh18_bwxd4gL8JY2Lg" 

# C·∫•u h√¨nh Model
MODEL_NAME = 'gemini-2.5-flash'

# K·∫øt n·ªëi AI
try:
    genai.configure(api_key=MY_API_KEY, transport='rest')
    model = genai.GenerativeModel(MODEL_NAME)
except Exception as e:
    st.error(f"‚ö†Ô∏è L·ªói c·∫•u h√¨nh API Key: {e}")

# --- 2. T·ª™ ƒêI·ªÇN D·ªÆ LI·ªÜU (Mapping th√¥ng minh - Phi√™n b·∫£n M·ªü r·ªông) ---
# C·∫•u tr√∫c: "t·ª´_kh√≥a_ng∆∞·ªùi_d√πng": {
#    "yahoo": "M√£ ƒë·ªÉ AI l·∫•y d·ªØ li·ªáu (Yahoo Finance)", 
#    "tv": "M√£ ƒë·ªÉ hi·ªán bi·ªÉu ƒë·ªì (TradingView)", 
#    "name": "T√™n hi·ªÉn th·ªã ƒë·∫πp"
# }

TU_DIEN_DATA = {
    # ==================================================
    # 1. H√ÄNG H√ìA (COMMODITIES) - V√ÄNG, B·∫†C, D·∫¶U
    # ==================================================
    "xauusd": {"yahoo": "GC=F", "tv": "OANDA:XAUUSD", "name": "ü•á V√†ng (Gold Spot)"},
    "gold":   {"yahoo": "GC=F", "tv": "OANDA:XAUUSD", "name": "ü•á V√†ng (Gold Spot)"},
    "vang":   {"yahoo": "GC=F", "tv": "OANDA:XAUUSD", "name": "ü•á V√†ng (Gold Spot)"},
    
    "silver": {"yahoo": "SI=F", "tv": "OANDA:XAGUSD", "name": "ü•à B·∫°c (Silver)"},
    "bac":    {"yahoo": "SI=F", "tv": "OANDA:XAGUSD", "name": "ü•à B·∫°c (Silver)"},
    "xagusd": {"yahoo": "SI=F", "tv": "OANDA:XAGUSD", "name": "ü•à B·∫°c (Silver)"},
    
    "usoil":  {"yahoo": "CL=F", "tv": "TVC:USOIL",    "name": "üõ¢Ô∏è D·∫ßu WTI (Crude Oil)"},
    "oil":    {"yahoo": "CL=F", "tv": "TVC:USOIL",    "name": "üõ¢Ô∏è D·∫ßu WTI (Crude Oil)"},
    "dau":    {"yahoo": "CL=F", "tv": "TVC:USOIL",    "name": "üõ¢Ô∏è D·∫ßu WTI (Crude Oil)"},
    
    "ukoil":  {"yahoo": "BZ=F", "tv": "TVC:UKOIL",    "name": "üõ¢Ô∏è D·∫ßu Brent"},

    # ==================================================
    # 2. TI·ªÄN ƒêI·ªÜN T·ª¨ (CRYPTO) - TOP COINS
    # ==================================================
    "btc":  {"yahoo": "BTC-USD", "tv": "BINANCE:BTCUSDT", "name": "‚Çø Bitcoin (BTC)"},
    "eth":  {"yahoo": "ETH-USD", "tv": "BINANCE:ETHUSDT", "name": "üíé Ethereum (ETH)"},
    "sol":  {"yahoo": "SOL-USD", "tv": "BINANCE:SOLUSDT", "name": "‚òÄÔ∏è Solana (SOL)"},
    "bnb":  {"yahoo": "BNB-USD", "tv": "BINANCE:BNBUSDT", "name": "üî∂ Binance Coin (BNB)"},
    "xrp":  {"yahoo": "XRP-USD", "tv": "BINANCE:XRPUSDT", "name": "‚ùå Ripple (XRP)"},
    "doge": {"yahoo": "DOGE-USD","tv": "BINANCE:DOGEUSDT","name": "üê∂ Dogecoin"},
    "ada":  {"yahoo": "ADA-USD", "tv": "BINANCE:ADAUSDT", "name": "üîµ Cardano (ADA)"},
    "link": {"yahoo": "LINK-USD","tv": "BINANCE:LINKUSDT","name": "üîó Chainlink"},

    # ==================================================
    # 3. CH·ª®NG KHO√ÅN VI·ªÜT NAM (TOP VN30 & HOT)
    # ==================================================
    "vnindex": {"yahoo": "^VNINDEX", "tv": "HOSE:VNINDEX", "name": "üáªüá≥ VN-Index"},
    
    # Ng√¢n h√†ng
    "vcb": {"yahoo": "VCB.VN", "tv": "HOSE:VCB", "name": "üè¶ Vietcombank"},
    "bid": {"yahoo": "BID.VN", "tv": "HOSE:BID", "name": "üè¶ BIDV"},
    "ctg": {"yahoo": "CTG.VN", "tv": "HOSE:CTG", "name": "üè¶ VietinBank"},
    "tcb": {"yahoo": "TCB.VN", "tv": "HOSE:TCB", "name": "üè¶ Techcombank"},
    "mb":  {"yahoo": "MBB.VN", "tv": "HOSE:MBB", "name": "üè¶ MB Bank"},
    "mbb": {"yahoo": "MBB.VN", "tv": "HOSE:MBB", "name": "üè¶ MB Bank"},
    "stb": {"yahoo": "STB.VN", "tv": "HOSE:STB", "name": "üè¶ Sacombank"},
    "acb": {"yahoo": "ACB.VN", "tv": "HOSE:ACB", "name": "üè¶ ACB"},
    "vpb": {"yahoo": "VPB.VN", "tv": "HOSE:VPB", "name": "üè¶ VPBank"},

    # B·∫•t ƒë·ªông s·∫£n & Th√©p
    "vic": {"yahoo": "VIC.VN", "tv": "HOSE:VIC", "name": "üèôÔ∏è Vingroup"},
    "vhm": {"yahoo": "VHM.VN", "tv": "HOSE:VHM", "name": "üèòÔ∏è Vinhomes"},
    "vre": {"yahoo": "VRE.VN", "tv": "HOSE:VRE", "name": "üõçÔ∏è Vincom Retail"},
    "nvl": {"yahoo": "NVL.VN", "tv": "HOSE:NVL", "name": "üèòÔ∏è Novaland"},
    "hpg": {"yahoo": "HPG.VN", "tv": "HOSE:HPG", "name": "üèóÔ∏è H√≤a Ph√°t"},
    "hsg": {"yahoo": "HSG.VN", "tv": "HOSE:HSG", "name": "üèóÔ∏è Hoa Sen"},
    "nkg": {"yahoo": "NKG.VN", "tv": "HOSE:NKG", "name": "üèóÔ∏è Nam Kim"},

    # Ch·ª©ng kho√°n & B√°n l·∫ª & Kh√°c
    "ssi": {"yahoo": "SSI.VN", "tv": "HOSE:SSI", "name": "üìà SSI Securities"},
    "vnd": {"yahoo": "VND.VN", "tv": "HOSE:VND", "name": "üìà VNDirect"},
    "fpt": {"yahoo": "FPT.VN", "tv": "HOSE:FPT", "name": "üíª FPT Corp"},
    "mwg": {"yahoo": "MWG.VN", "tv": "HOSE:MWG", "name": "üì± Th·∫ø Gi·ªõi Di ƒê·ªông"},
    "msn": {"yahoo": "MSN.VN", "tv": "HOSE:MSN", "name": "üçú Masan Group"},
    "vnm": {"yahoo": "VNM.VN", "tv": "HOSE:VNM", "name": "ü•õ Vinamilk"},
    "sab": {"yahoo": "SAB.VN", "tv": "HOSE:SAB", "name": "üç∫ Sabeco"},
    "gas": {"yahoo": "GAS.VN", "tv": "HOSE:GAS", "name": "‚õΩ PV Gas"},

    # ==================================================
    # 4. CH·ª®NG KHO√ÅN M·ª∏ (US STOCKS)
    # ==================================================
    # C√¥ng ngh·ªá (Big Tech)
    "tsla": {"yahoo": "TSLA", "tv": "NASDAQ:TSLA", "name": "üöó Tesla Inc"},
    "aapl": {"yahoo": "AAPL", "tv": "NASDAQ:AAPL", "name": "üçé Apple Inc"},
    "msft": {"yahoo": "MSFT", "tv": "NASDAQ:MSFT", "name": "üíª Microsoft"},
    "goog": {"yahoo": "GOOGL","tv": "NASDAQ:GOOGL","name": "üîç Google (Alphabet)"},
    "amzn": {"yahoo": "AMZN", "tv": "NASDAQ:AMZN", "name": "üì¶ Amazon"},
    "meta": {"yahoo": "META", "tv": "NASDAQ:META", "name": "‚ôæÔ∏è Meta (Facebook)"},
    "nvda": {"yahoo": "NVDA", "tv": "NASDAQ:NVDA", "name": "ü§ñ NVIDIA"},
    "amd":  {"yahoo": "AMD",  "tv": "NASDAQ:AMD",  "name": "üíæ AMD"},
    "nflx": {"yahoo": "NFLX", "tv": "NASDAQ:NFLX", "name": "üé¨ Netflix"},
    "intc": {"yahoo": "INTC", "tv": "NASDAQ:INTC", "name": "üíæ Intel"},

    # C√°c m√£ ph·ªï bi·∫øn kh√°c
    "ko":   {"yahoo": "KO",   "tv": "NYSE:KO",     "name": "ü•§ Coca-Cola"},
    "pep":  {"yahoo": "PEP",  "tv": "NASDAQ:PEP",  "name": "ü•§ PepsiCo"},
    "mcd":  {"yahoo": "MCD",  "tv": "NYSE:MCD",    "name": "üçî McDonald's"},
    "dis":  {"yahoo": "DIS",  "tv": "NYSE:DIS",    "name": "üè∞ Disney"},
    "nke":  {"yahoo": "NKE",  "tv": "NYSE:NKE",    "name": "üëü Nike"},
    
    # ==================================================
    # 5. NGO·∫†I H·ªêI (FOREX) & CH·ªà S·ªê (INDICES)
    # ==================================================
    "eurusd": {"yahoo": "EURUSD=X", "tv": "FX:EURUSD", "name": "üí∂ EUR/USD"},
    "gbpusd": {"yahoo": "GBPUSD=X", "tv": "FX:GBPUSD", "name": "üí∑ GBP/USD"},
    "usdjpy": {"yahoo": "JPY=X",    "tv": "FX:USDJPY", "name": "üí¥ USD/JPY"},
    "audusd": {"yahoo": "AUDUSD=X", "tv": "FX:AUDUSD", "name": "üá¶üá∫ AUD/USD"},
    "usdcad": {"yahoo": "CAD=X",    "tv": "FX:USDCAD", "name": "üá®üá¶ USD/CAD"},
    
    "dxy":    {"yahoo": "DX-Y.NYB", "tv": "TVC:DXY",   "name": "üí≤ DXY (Dollar Index)"},
    
    # Ch·ªâ s·ªë ch·ª©ng kho√°n M·ªπ
    "us30":   {"yahoo": "^DJI",     "tv": "TVC:DJI",   "name": "üá∫üá∏ Dow Jones (US30)"},
    "dow":    {"yahoo": "^DJI",     "tv": "TVC:DJI",   "name": "üá∫üá∏ Dow Jones (US30)"},
    "us500":  {"yahoo": "^GSPC",    "tv": "TVC:SPX",   "name": "üá∫üá∏ S&P 500"},
    "spx":    {"yahoo": "^GSPC",    "tv": "TVC:SPX",   "name": "üá∫üá∏ S&P 500"},
    "us100":  {"yahoo": "^IXIC",    "tv": "TVC:IXIC",  "name": "üá∫üá∏ Nasdaq 100"},
    "nasdaq": {"yahoo": "^IXIC",    "tv": "TVC:IXIC",  "name": "üá∫üá∏ Nasdaq 100"},
}
# --- 3. C√ÅC H√ÄM X·ª¨ L√ù (Backend) ---

def ham_tim_kiem(searchterm: str):
    if not searchterm:
        return [("üî• V√†ng (Gold)", "xauusd"), ("‚Çø Bitcoin (BTC)", "btc"), ("üáªüá≥ VnIndex", "vnindex")]

    query = searchterm.lower().strip()
    ket_qua = []

    if ":" in query:
        return [(f"üåç M√£ s√†n c·ª• th·ªÉ: {searchterm.upper()}", f"DIRECT|{searchterm.upper()}")]

    count = 0
    for key, data in TU_DIEN_DATA.items():
        if query in key or query in data['name'].lower():
            ket_qua.append((f"‚ú® {data['name']}", key))
            count += 1
            if count >= 5: break
    
    if len(ket_qua) < 3:
        try:
            url = "https://query2.finance.yahoo.com/v1/finance/search"
            params = {'q': query, 'quotesCount': 5}
            headers = {'User-Agent': 'Mozilla/5.0'}
            r = requests.get(url, params=params, headers=headers, timeout=1).json()
            if 'quotes' in r:
                for i in r['quotes']:
                    sym = i.get('symbol', '')
                    name = i.get('shortname') or sym
                    tv_suggestion = sym
                    if ".VN" in sym: tv_suggestion = f"HOSE:{sym.replace('.VN','')}"
                    elif "=X" in sym: tv_suggestion = f"FX:{sym.replace('=X','')}"
                    elif "-USD" in sym: tv_suggestion = f"BINANCE:{sym.replace('-USD','USDT')}"
                    ket_qua.append((f"üåê {name} ({sym})", f"YAHOO_SEARCH|{sym}|{tv_suggestion}"))
        except: pass
        
    return ket_qua

@st.cache_data(ttl=600)
def lay_du_lieu_yahoo(symbol):
    try:
        ticker = yf.Ticker(symbol)
        df = ticker.history(period="3mo")
        if df.empty: return None, None, None
        df['RSI'] = df.ta.rsi(length=14)
        return df['Close'].iloc[-1], df['RSI'].iloc[-1], ticker.news
    except: return None, None, None

@st.cache_data(ttl=3600)
def goi_ai_phan_tich(symbol, gia, rsi, news):
    tin = "Kh√¥ng c√≥ tin t·ª©c quan tr·ªçng."
    if news:
        dstt = [f"- {n.get('title','')}" for n in news[:3] if n]
        tin = "\n".join(dstt)

    prompt = f"""
    B·∫°n l√† S√≥i Gi√† Ph·ªë Wall. Ph√¢n t√≠ch m√£ {symbol}:
    - Gi√°: {gia:,.2f}
    - RSI (14): {rsi:.2f}
    - Tin t·ª©c: {tin}
    
    Tr·∫£ l·ªùi ng·∫Øn g·ªçn, format Markdown:
    1. **Xu h∆∞·ªõng**: (TƒÉng/Gi·∫£m/Sideway)
    2. **Ph√¢n t√≠ch k·ªπ thu·∫≠t**: ƒê√°nh gi√° RSI v√† h√†nh ƒë·ªông gi√°.
    3. ** Ph√¢n t√≠ch tin t·ª©c**: T√≥m t·∫Øt t√°c ƒë·ªông ch√≠nh to√†n c·∫ßu.
    4. **KHUY·∫æN NGH·ªä**: (MUA / B√ÅN / QUAN S√ÅT) k√®m v√πng gi√°.
    """
    try:
        return model.generate_content(prompt).text
    except Exception as e:
        return f"‚ö†Ô∏è AI Busy: {str(e)}"

# --- 4. GIAO DI·ªÜN NG∆Ø·ªúI D√ôNG (Frontend) ---

st.markdown("""
<style>
    .stApp { background-color: #0e1117; color: white; }
    h1 { color: #4CAF50; }
</style>
""", unsafe_allow_html=True)

with st.sidebar:
    st.title("ü¶Å AI TRADING PRO")
    search_key = st_searchbox(ham_tim_kiem, key="main_search", label="üîç T√¨m ki·∫øm t√†i s·∫£n")
    st.caption("Nh·∫≠p t√™n m√£ ho·∫∑c ch·ªçn t·ª´ danh s√°ch")

if search_key:
    # --- X·ª¨ L√ù LOGIC ---
    yahoo_code, tv_code, display_name = "", "", ""

    if search_key in TU_DIEN_DATA:
        d = TU_DIEN_DATA[search_key]
        yahoo_code, tv_code, display_name = d['yahoo'], d['tv'], d['name']
    elif "DIRECT|" in search_key:
        tv_code = search_key.split("|")[1]
        display_name = tv_code
        sym = tv_code.split(":")[1] if ":" in tv_code else tv_code
        yahoo_code = f"{sym}=X" if "USD" in sym else sym
    elif "YAHOO_SEARCH|" in search_key:
        parts = search_key.split("|")
        yahoo_code, tv_code, display_name = parts[1], parts[2], parts[1]

    # --- HI·ªÇN TH·ªä ---
    st.title(f"üìä {display_name}")

    col1, col2 = st.columns([35, 65], gap="medium")

    # C·ªòT TR√ÅI: AI & D·ªÆ LI·ªÜU
    with col1:
        st.subheader("ü§ñ Ph√¢n t√≠ch AI")
        with st.spinner('ƒêang t·∫£i d·ªØ li·ªáu...'):
            gia, rsi, tin = lay_du_lieu_yahoo(yahoo_code)
            
            if gia:
                c1, c2 = st.columns(2)
                c1.metric("Gi√° Hi·ªán T·∫°i", f"{gia:,.2f}")
                status_rsi = "Qu√° Mua üî¥" if rsi > 70 else "Qu√° B√°n üü¢" if rsi < 30 else "Trung t√≠nh ‚ö™"
                c2.metric("RSI (14)", f"{rsi:.1f}", status_rsi)
                
                st.markdown("---")
                nhan_dinh = goi_ai_phan_tich(yahoo_code, gia, rsi, tin)
                st.markdown(nhan_dinh)
            else:
                st.warning(f"Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu Yahoo cho m√£: {yahoo_code}")

    # C·ªòT PH·∫¢I: H·ªÜ TH·ªêNG BI·ªÇU ƒê·ªí K√âP
    with col2:
        # 1. BI·ªÇU ƒê·ªí CH√çNH (PRICE ACTION)
        st.markdown("**1. Bi·ªÉu ƒë·ªì gi√° & H√†nh ƒë·ªông th·ªã tr∆∞·ªùng**")
        html_chart_main = f"""
        <div class="tradingview-widget-container" style="height: 500px; width: 100%; margin-bottom: 20px;">
          <div id="tradingview_main" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
          new TradingView.widget(
          {{
            "autosize": true,
            "symbol": "{tv_code}", 
            "interval": "D",
            "timezone": "Asia/Ho_Chi_Minh",
            "theme": "dark",
            "style": "1",
            "locale": "vi_VN",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true, 
            "container_id": "tradingview_main"
          }});
          </script>
        </div>
        """
        components.html(html_chart_main, height=500)

        # 2. BI·ªÇU ƒê·ªí PH·ª§ (CH·ªà B√ÅO K·ª∏ THU·∫¨T) - T√çNH NƒÇNG M·ªöI
        st.markdown("**2. Ch·ªâ b√°o k·ªπ thu·∫≠t (RSI, MACD, Bollinger Bands)**")
        html_chart_indicators = f"""
        <div class="tradingview-widget-container" style="height: 400px; width: 100%;">
          <div id="tradingview_ind" style="height: 100%; width: 100%;"></div>
          <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
          <script type="text/javascript">
          new TradingView.widget(
          {{
            "autosize": true,
            "symbol": "{tv_code}", 
            "interval": "D",
            "timezone": "Asia/Ho_Chi_Minh",
            "theme": "dark",
            "style": "1",
            "locale": "vi_VN",
            "enable_publishing": false,
            "hide_top_toolbar": true,
            "hide_legend": false,
            "studies": [
                "RSI@tv-basicstudies",
                "MACD@tv-basicstudies",
                "BB@tv-basicstudies"
            ],
            "container_id": "tradingview_ind"
          }});
          </script>
        </div>
        """
        components.html(html_chart_indicators, height=400)

else:
    st.markdown("<br><br><h2 style='text-align:center; color:gray'>üëà H√£y ch·ªçn m·ªôt m√£ ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch</h2>", unsafe_allow_html=True)